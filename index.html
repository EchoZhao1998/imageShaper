<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Shape Cropper</title>
  <style>
    body {
      font-family: sans-serif;
      padding: 20px;
    }
    canvas {
      border: 1px solid #ccc;
      display: block;
      margin-top: 10px;
    }
  </style>
</head>
<body>

<h1>Shape Cropper</h1>

<input type="file" id="upload" accept="image/*" />

<canvas id="canvas" width="400" height="400"></canvas>

<script>
  const upload = document.getElementById("upload");
  const canvas = document.getElementById("canvas");
  const ctx = canvas.getContext("2d");

  let img = null;

  // image position
  let imgX = 0;
  let imgY = 0;

  // image draw size (IMPORTANT: global)
  let drawWidth = 0;
  let drawHeight = 0;

  // dragging state
  let isDragging = false;
  let startX = 0;
  let startY = 0;

  // shapes
  let currentShape = "circle"; // future: "rounded-rect"

  canvas.addEventListener("mousedown", (e) => {
    if (!img) return;
    isDragging = true;
    startX = e.offsetX;
    startY = e.offsetY;
  });

  canvas.addEventListener("mousemove", (e) => {
    if (!isDragging || !img) return;

    const dx = e.offsetX - startX;
    const dy = e.offsetY - startY;

    imgX += dx;
    imgY += dy;

    startX = e.offsetX;
    startY = e.offsetY;

    redraw();
  });

  canvas.addEventListener("mouseup", () => {
    isDragging = false;
  });

  canvas.addEventListener("mouseleave", () => {
    isDragging = false;
  });

  function redraw() {
    if (!img) return;

    ctx.clearRect(0, 0, canvas.width, canvas.height);

    ctx.save();

    // circle mask
    ctx.beginPath();

    if (currentShape === "circle") {
        ctx.arc(
            canvas.width / 2,
            canvas.height / 2,
            canvas.width / 2,
            0,
            Math.PI * 2
      );
    }

    ctx.clip();
}

ctx.clip();

    ctx.drawImage(img, imgX, imgY, drawWidth, drawHeight);

    ctx.restore();

  upload.addEventListener("change", (e) => {
    const file = e.target.files[0];
    if (!file) return;

    img = new Image();

    img.onload = () => {
      const canvasRatio = canvas.width / canvas.height;
      const imgRatio = img.width / img.height;

      if (imgRatio > canvasRatio) {
        // image is wider
        drawHeight = canvas.height;
        drawWidth = img.width * (canvas.height / img.height);
        imgX = -(drawWidth - canvas.width) / 2;
        imgY = 0;
      } else {
        // image is taller
        drawWidth = canvas.width;
        drawHeight = img.height * (canvas.width / img.width);
        imgX = 0;
        imgY = -(drawHeight - canvas.height) / 2;
      }

      redraw();
    };

    img.src = URL.createObjectURL(file);
  });
</script>

</body>
</html>